
- debug:
    msg: 
      - "tfstate {{tfstate}} - {{tfstates[tfstate]}}"
      - "{{lz_type}}"

- set_fact:
    tfstate_key: "{{ tfstates[tfstate].keys() | first }}"
    env: "{{ tfstates[tfstate].values() | first | default('') }}"


- name: "Set tfstate_object"
  set_fact:
    tfstate_object: '{{config.tfstates[lz_type][tfstate_key] if env == "" else config.tfstates[lz_type][tfstate_key][env] }}'

- name: "Set config_folder"
  set_fact:
    config_folder: '{{ tfstate_object.sub_template_folder | default() }}'

- debug:
    msg:
      - "{{config}}"
      - "{{lz_type}}"
      - "{{tfstate_key}}"
      - "{{env}}"
      - "{{tfstate_object}}"
      - "{{config_folder}}"
    verbosity: 2

- set_fact:
    resources: "{{ lookup('file', '{{ config_folder + \"/\" + tfstate_object.config_file }}') | from_yaml }}"

- name: "Including tasks process_tfstate.yaml"
  include_tasks: "process_tfstate.yaml"
  loop: ["{{tfstate_key}}"]
  loop_control:
    loop_var: deployment
  vars:
    config_file: "{{config_folder + '/' + tfstate_object.config_file }}"