#
# Execute the following command to get the billing_account_name and management_group_id
#
# az rest --method get --uri https://management.azure.com/providers/Microsoft.Billing/billingaccounts/?api-version=2020-05-01
#
# To retrieve the first billing account
#
# billing_account_name=$(az rest --method get --uri https://management.azure.com/providers/Microsoft.Billing/billingaccounts?api-version=2020-05-01 --query "value[?properties.agreementType=='EnterpriseAgreement'].{name:name}" -o tsv)
#
# enrollment_account_name=$(az rest --method get --uri https://management.azure.com/providers/Microsoft.Billing/billingaccounts?api-version=2020-05-01 --query "value[?properties.agreementType=='EnterpriseAgreement'].{name:properties.enrollmentAccounts[0].name}" -o tsv)
#

subscriptions = {
{% for key, value in resources[tfstate_resource].subscriptions[subscription_key].subscriptions.items() %}
  {{ key }} = {
    name                    = "{{ value.name }}"
{% if value.create_alias is defined %}
    create_alias            = {{ value.create_alias | lower}}
{% endif %}
{% if value.subscription_id is not defined %}
    billing_account_name    = "{{ resources.caf_terraform.billing_subscription_role_delegations.billing_account_name }}"
    enrollment_account_name = "{{ resources.caf_terraform.billing_subscription_role_delegations.enrollment_account_name }}"
{% if value.management_group_suffix is defined %}
    management_group_id     = "{{ resources.platform_core_setup.enterprise_scale.management_group_prefix }}-{{ value.management_group_suffix }}"
{% else %}
    management_group_id     = "{{ value.management_group_id }}"
{% endif %}
    workload                = "{{ value.workload | default('Production') }}"
{% if value.tags is defined %}
    tags                    = {
{% for tag_key in value.tags %}
      {{ tag_key }} = "{{ value.tags[tag_key] }}"
{% endfor %}
    }
{% endif %}
{% else %}
    subscription_id = "{{value.subscription_id}}"
{% endif %}
  }
{% endfor %}
}